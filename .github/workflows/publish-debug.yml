name: Debug PyPI Trusted Publisher

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  show-oidc-claims:
    name: Debug Trusted Publisher Claims
    runs-on: ubuntu-latest
    environment: pypi # Must match exactly your PyPI Trusted Publisher environment name

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Request OIDC token and show claims
        id: oidc-debug
        run: |
          echo "üîç Requesting GitHub OIDC token for PyPI..."
          # Request an OIDC token for audience=pypi
          TOKEN=$(curl -sSL -X POST \
            -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=pypi" | jq -r '.value')

          echo "‚úÖ Token acquired, decoding claims..."
          echo "$TOKEN" | awk -F. '{print $2}' | base64 --decode | jq
